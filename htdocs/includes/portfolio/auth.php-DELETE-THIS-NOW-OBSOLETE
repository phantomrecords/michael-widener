<?php
declare(strict_types=1);

require_once __DIR__ . '/../auth.php';

function h(string $s): string { return htmlspecialchars($s, ENT_QUOTES); }

if (!function_exists('is_logged_in') || !is_logged_in()) {
  redirect('/login/?next=' . rawurlencode('/portfolio/'));
}

// Requested file path (or directory listing)
$req = isset($_GET['path']) ? (string)$_GET['path'] : '';
$req = ltrim($req, '/');

// Basic traversal defense
if ($req !== '' && (str_contains($req, '..') || str_contains($req, "\0"))) {
  http_response_code(400);
  echo "Bad request.";
  exit;
}

$baseDir = realpath(__DIR__);
if ($baseDir === false) {
  http_response_code(500);
  echo "Server misconfiguration.";
  exit;
}

$target = $req === '' ? $baseDir : realpath($baseDir . DIRECTORY_SEPARATOR . $req);

// If file doesn't exist (or realpath failed), show listing instead of leaking paths
if ($target === false || !str_starts_with($target, $baseDir)) {
  $target = $baseDir;
}

// If it's a file, stream it (so it stays protected behind login)
if (is_file($target)) {
  $ext = strtolower(pathinfo($target, PATHINFO_EXTENSION));

  $mime = match ($ext) {
    'pdf'  => 'application/pdf',
    'png'  => 'image/png',
    'jpg', 'jpeg' => 'image/jpeg',
    'gif'  => 'image/gif',
    'webp' => 'image/webp',
    'svg'  => 'image/svg+xml',
    'html', 'htm' => 'text/html; charset=utf-8',
    'css'  => 'text/css; charset=utf-8',
    'js'   => 'application/javascript; charset=utf-8',
    default => 'application/octet-stream',
  };

  header('Content-Type: ' . $mime);
  header('X-Content-Type-Options: nosniff');
  header('Content-Length: ' . (string)filesize($target));

  // For PDFs you may prefer inline viewing:
  // header('Content-Disposition: inline; filename="' . basename($target) . '"');

  readfile($target);
  exit;
}

// Otherwise: directory listing UI (simple, matches your black/white vibe)
$items = scandir($target) ?: [];
$relDir = trim(str_replace($baseDir, '', $target), DIRECTORY_SEPARATOR);
$relDir = $relDir === '' ? '' : $relDir . '/';

?><!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Portfolio (Private)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --maxw: 820px; }
    html, body { margin:0; padding:0; background:#fff; color:#000; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans",sans-serif; line-height:1.55; }
    .page { max-width: var(--maxw); margin: 2rem auto 3rem; padding: 0 1rem; }
    h1 { font-size: 1.35rem; margin: 0 0 .5rem; }
    p { margin: .35rem 0 .75rem; }
    hr { border:0; border-top:1px solid #000; margin: 1rem 0; }
    a { color: inherit; text-decoration: underline; }
    ul { list-style: none; padding: 0; margin: .75rem 0 0; }
    li { padding: .45rem 0; border-bottom: 1px solid #000; }
    .muted { font-size: .92rem; }
    .tag { display:inline-block; border:1px solid #000; padding:.05rem .4rem; margin-left:.35rem; font-size:.85rem; }
  </style>
</head>
<body>
  <div class="page">
    <h1>Portfolio (Private)</h1>
    <p class="muted">Visible only after login. Files stream through PHP so they stay protected.</p>
    <p><a href="/">‚Üê Home</a></p>
    <hr />

    <p><strong>Folder:</strong> /portfolio/<?php echo h($relDir); ?></p>

    <ul>
      <?php if ($relDir !== ''): ?>
        <?php
          $parent = rtrim(dirname($relDir), '/');
          $parentHref = $parent === '.' ? '' : $parent . '/';
        ?>
        <li><a href="?path=<?php echo h($parentHref); ?>">.. (parent)</a> <span class="tag">DIR</span></li>
      <?php endif; ?>

      <?php foreach ($items as $name): ?>
        <?php
          if ($name === '.' || $name === '..') continue;
          if ($name[0] === '.') continue; // hide dotfiles
          $full = $target . DIRECTORY_SEPARATOR . $name;
          $isDir = is_dir($full);
          $href = '?path=' . rawurlencode($relDir . $name . ($isDir ? '/' : ''));
        ?>
        <li>
          <a href="<?php echo h($href); ?>"><?php echo h($name); ?></a>
          <?php if ($isDir): ?><span class="tag">DIR</span><?php endif; ?>
        </li>
      <?php endforeach; ?>
    </ul>
  </div>
</body>
</html>
